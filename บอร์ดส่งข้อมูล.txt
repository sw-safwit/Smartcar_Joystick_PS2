#include <PS2X_lib.h>       //for v1.6
#define PS2_DAT 12          // GPIO 12 (D6)
#define PS2_CMD 13          // GPIO 13 (D7)
#define PS2_SEL 0           // GPIO 0 (D3) - ใช้สำหรับขา CS/ATT
#define PS2_CLK 14          // GPIO 14 (D5)
const int pinPositive = 5;  // D1
const int pinNegative = 4;  // D2
//#define pressures    true
#define pressures false
//#define rumble         true
#define rumble false
PS2X ps2x;  // create PS2 Controller Class
int error = 0;
byte type = 0;
byte vibrate = 0;
void setup() {
  Serial.begin(115200);
  delay(300);  //ให้เวลา module startup
  pinMode(pinPositive, OUTPUT);
  pinMode(pinNegative, OUTPUT);
  error = ps2x.config_gamepad(PS2_CLK, PS2_CMD, PS2_SEL, PS2_DAT, pressures, rumble);

  //ตรวจ Error
  if (error == 0) {
    Serial.print("Found Controller, configured successful ");
  } else if (error == 1)
    Serial.println("ERROR 1: No controller found, check wiring and wireless link.");
  else if (error == 2)
    Serial.println("ERROR 2: Controller found but not accepting commands.");
  else if (error == 3)
    Serial.println("ERROR 3: Controller refusing to enter Pressures mode.");

  //ชนิดรีโมทที่รับ
  type = ps2x.readType();
  switch (type) {
    case 0:
      Serial.print("Unknown Controller type found ");
      break;
    case 1:
      Serial.print("DualShock Controller found ");
      break;
    case 2:
      Serial.print("GuitarHero Controller found ");
      break;
    case 3:
      Serial.print("Wireless Sony DualShock Controller found ");
      break;
  }
}

String lastCommand = "Stop";

void loop() {

if (error == 1) return;
  ps2x.read_gamepad(false, vibrate);

  String currentCommand = "Stop";

  // เช็คปุ่มที่กด
  if (ps2x.Button(PSB_PAD_UP))    currentCommand = "Up";
  else if (ps2x.Button(PSB_PAD_DOWN))  currentCommand = "Down";
  else if (ps2x.Button(PSB_PAD_LEFT))  currentCommand = "LEFT";
  else if (ps2x.Button(PSB_PAD_RIGHT)) currentCommand = "Right";

  // ส่งข้อมูลเฉพาะตอนที่ "เปลี่ยน" สถานะปุ่มเท่านั้น
  if (currentCommand != lastCommand) {
    Serial.println(currentCommand);
    lastCommand = currentCommand;
  }

  delay(20); 

}